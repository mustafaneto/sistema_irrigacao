// Aplica√ß√£o principal
class App {
    constructor() {
        this.currentTab = 'dashboard';
        this.modules = {};
        this.init();
    }

    // Inicializar aplica√ß√£o
    async init() {
        console.log('üöÄ Iniciando Sistema de Irriga√ß√£o...');
        
        // Aguardar carregamento do DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.setupApp());
        } else {
            this.setupApp();
        }
    }

    // Configurar aplica√ß√£o
    async setupApp() {
        try {
            // Testar conex√£o com a API
            await this.testConnection();
            
            // Configurar navega√ß√£o
            this.setupNavigation();
            
            // Configurar m√≥dulos
            this.setupModules();
            
            // Configurar eventos globais
            this.setupGlobalEvents();
            
            // Carregar dados iniciais
            await this.loadInitialData();
            
            console.log('‚úÖ Aplica√ß√£o inicializada com sucesso!');
            
        } catch (error) {
            console.error('‚ùå Erro ao inicializar aplica√ß√£o:', error);
            Utils.mostrarNotificacao('Erro ao inicializar aplica√ß√£o', 'error');
        }
    }

    // Testar conex√£o com a API
    async testConnection() {
        try {
            const isConnected = await api.testarConexao();
            if (!isConnected) {
                throw new Error('N√£o foi poss√≠vel conectar com o servidor');
            }
            console.log('‚úÖ Conex√£o com API estabelecida');
        } catch (error) {
            console.warn('‚ö†Ô∏è Erro de conex√£o com API:', error.message);
            Utils.mostrarNotificacao('Verificando conex√£o com o servidor...', 'warning');
        }
    }

    // Configurar navega√ß√£o
    setupNavigation() {
        const navButtons = document.querySelectorAll('.nav-btn');
        
        navButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tab = e.target.dataset.tab;
                this.switchTab(tab);
            });
        });
    }

    // Trocar de aba
    switchTab(tabName) {
        // Remover classe active de todas as abas
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Adicionar classe active √† aba selecionada
        const targetTab = document.getElementById(tabName);
        const targetBtn = document.querySelector(`[data-tab="${tabName}"]`);
        
        if (targetTab && targetBtn) {
            targetTab.classList.add('active');
            targetBtn.classList.add('active');
            this.currentTab = tabName;
            
            // Carregar dados espec√≠ficos da aba
            this.loadTabData(tabName);
        }
    }

    // Carregar dados espec√≠ficos da aba
    loadTabData(tabName) {
        switch (tabName) {
            case 'dashboard':
                if (dashboard) {
                    dashboard.refreshData();
                }
                break;
            case 'historico':
                if (this.modules.historico) {
                    this.modules.historico.loadData();
                }
                break;
            case 'configuracoes':
                if (this.modules.configuracoes) {
                    this.modules.configuracoes.loadConfiguracoes();
                }
                break;
            case 'alertas':
                if (this.modules.alertas) {
                    this.modules.alertas.loadAlertas();
                }
                break;
        }
    }

    // Configurar m√≥dulos
    setupModules() {
        // Inicializar m√≥dulos quando necess√°rio
        this.modules = {
            dashboard: window.dashboard,
            historico: window.historico,
            configuracoes: window.configuracoes,
            alertas: window.alertas
        };
    }

    // Configurar eventos globais
    setupGlobalEvents() {
        // Evento de online/offline
        window.addEventListener('online', () => {
            Utils.mostrarNotificacao('Conex√£o restaurada!', 'success');
            this.refreshAllData();
        });

        window.addEventListener('offline', () => {
            Utils.mostrarNotificacao('Conex√£o perdida. Verificando...', 'warning');
        });

        // Evento de visibilidade da p√°gina
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Pausar atualiza√ß√µes quando a p√°gina n√£o est√° vis√≠vel
                if (dashboard) dashboard.stopAutoRefresh();
            } else {
                // Retomar atualiza√ß√µes quando a p√°gina volta a ficar vis√≠vel
                if (dashboard) dashboard.startAutoRefresh();
                this.refreshAllData();
            }
        });

        // Evento de redimensionamento
        window.addEventListener('resize', Utils.debounce(() => {
            // Redimensionar gr√°ficos se necess√°rio
            if (chartManager.charts.umidade) {
                chartManager.charts.umidade.resize();
            }
        }, 250));

        // Evento de teclas de atalho
        document.addEventListener('keydown', (e) => {
            this.handleKeyboardShortcuts(e);
        });

        // Evento de clique fora de modais/toasts
        document.addEventListener('click', (e) => {
            this.handleOutsideClicks(e);
        });
    }

    // Tratar atalhos de teclado
    handleKeyboardShortcuts(e) {
        // Ctrl/Cmd + R para atualizar
        if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
            e.preventDefault();
            this.refreshAllData();
        }

        // F5 para atualizar
        if (e.key === 'F5') {
            e.preventDefault();
            this.refreshAllData();
        }

        // N√∫meros para trocar de aba
        if (e.key >= '1' && e.key <= '4') {
            const tabs = ['dashboard', 'historico', 'configuracoes', 'alertas'];
            const tabIndex = parseInt(e.key) - 1;
            if (tabs[tabIndex]) {
                this.switchTab(tabs[tabIndex]);
            }
        }
    }

    // Tratar cliques fora de elementos
    handleOutsideClicks(e) {
        // Fechar toasts ao clicar fora
        const toasts = document.querySelectorAll('.toast');
        toasts.forEach(toast => {
            if (!toast.contains(e.target)) {
                toast.remove();
            }
        });
    }

    // Carregar dados iniciais
    async loadInitialData() {
        try {
            // Carregar configura√ß√µes salvas
            this.loadSavedPreferences();
            
            // Verificar se h√° alertas n√£o lidos
            await this.checkUnreadAlerts();
            
        } catch (error) {
            console.error('Erro ao carregar dados iniciais:', error);
        }
    }

    // Carregar prefer√™ncias salvas
    loadSavedPreferences() {
        const preferences = Utils.carregarLocalStorage(STORAGE_KEYS.USER_PREFERENCES, {});
        
        // Aplicar prefer√™ncias salvas
        if (preferences.lastTab) {
            this.switchTab(preferences.lastTab);
        }
        
        if (preferences.chartPeriod) {
            chartManager.currentPeriod = preferences.chartPeriod;
        }
    }

    // Salvar prefer√™ncias
    savePreferences() {
        const preferences = {
            lastTab: this.currentTab,
            chartPeriod: chartManager.currentPeriod
        };
        
        Utils.salvarLocalStorage(STORAGE_KEYS.USER_PREFERENCES, preferences);
    }

    // Verificar alertas n√£o lidos
    async checkUnreadAlerts() {
        try {
            const response = await api.getAlertas();
            if (response.success && response.data) {
                const unreadCount = response.data.filter(alerta => !alerta.lido).length;
                this.updateAlertBadge(unreadCount);
            }
        } catch (error) {
            console.error('Erro ao verificar alertas:', error);
        }
    }

    // Atualizar badge de alertas
    updateAlertBadge(count) {
        const badge = document.getElementById('alertas-badge');
        if (badge) {
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    // Atualizar todos os dados
    async refreshAllData() {
        try {
            // Atualizar dados do dashboard
            if (dashboard) {
                await dashboard.refreshData();
            }
            
            // Atualizar alertas
            await this.checkUnreadAlerts();
            
            // Atualizar dados espec√≠ficos da aba atual
            this.loadTabData(this.currentTab);
            
        } catch (error) {
            console.error('Erro ao atualizar dados:', error);
        }
    }

    // Mostrar informa√ß√µes do sistema
    showSystemInfo() {
        const info = {
            'Vers√£o da Aplica√ß√£o': '1.0.0',
            'Navegador': navigator.userAgent,
            'Resolu√ß√£o': `${window.innerWidth}x${window.innerHeight}`,
            'Online': navigator.onLine ? 'Sim' : 'N√£o',
            'Local Storage': navigator.storage ? 'Dispon√≠vel' : 'N√£o dispon√≠vel',
            'API URL': CONFIG.API_BASE_URL
        };

        console.table(info);
        Utils.mostrarNotificacao('Informa√ß√µes do sistema no console', 'info');
    }

    // Limpar cache e dados
    clearCache() {
        try {
            // Limpar localStorage
            Object.values(STORAGE_KEYS).forEach(key => {
                localStorage.removeItem(key);
            });
            
            // Limpar gr√°ficos
            chartManager.destroyAllCharts();
            
            Utils.mostrarNotificacao('Cache limpo com sucesso!', 'success');
            
            // Recarregar p√°gina
            setTimeout(() => {
                window.location.reload();
            }, 1000);
            
        } catch (error) {
            console.error('Erro ao limpar cache:', error);
            Utils.mostrarNotificacao('Erro ao limpar cache', 'error');
        }
    }

    // Destruir aplica√ß√£o
    destroy() {
        // Parar todas as atualiza√ß√µes autom√°ticas
        if (dashboard) dashboard.destroy();
        
        // Destruir gr√°ficos
        chartManager.destroyAllCharts();
        
        // Salvar prefer√™ncias
        this.savePreferences();
        
        console.log('üëã Aplica√ß√£o finalizada');
    }
}

// Inicializar aplica√ß√£o quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', () => {
    window.app = new App();
});

// Evento de antes de descarregar a p√°gina
window.addEventListener('beforeunload', () => {
    if (window.app) {
        window.app.destroy();
    }
});

// Expor fun√ß√µes globais para debug
window.showSystemInfo = () => window.app.showSystemInfo();
window.clearCache = () => window.app.clearCache();
window.refreshAll = () => window.app.refreshAllData(); 